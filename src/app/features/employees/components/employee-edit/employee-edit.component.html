<!-- タイトル -->
<div class="row mb-4 mt-4 align-items-center">
  <div class="col-12 col-md-12 offset-md-0">
    <h1 class="mb-4 border-bottom pb-2 d-flex align-items-center">
    <app-icon name="user_bk" class="title-icon me-2"></app-icon>
      プロフィール編集
    </h1>

    <form
      #form="ngForm"
      (ngSubmit)="onSubmit(form)"
      class="needs-validation"
      novalidate
    >
      <!-- 従業員番号（編集不可） -->
      <div class="row mb-4">
        <div class="col-12 col-md-6">
          <label for="code" class="form-label">従業員番号</label>
          <input
            type="text"
            id="code"
            class="form-control"
            [(ngModel)]="employee.code"
            name="code"
            readonly
            disabled
          />
        </div>
      </div>

      <!-- 氏名 -->
      <div class="row g-3 mb-4">
        <div class="col-12 col-md-6">
          <label for="lastName" class="form-label">姓</label>
          <input
            type="text"
            id="lastName"
            class="form-control"
            placeholder="例: 山田"
            [(ngModel)]="employee.lastName"
            name="lastName"
            required
            #lastNameInput="ngModel"
          />
          <div
            *ngIf="lastNameInput.invalid && lastNameInput.touched"
            class="form-text text-danger"
          >
            姓を入力してください。
          </div>
        </div>
        <div class="col-12 col-md-6">
          <label for="firstName" class="form-label">名</label>
          <input
            type="text"
            id="firstName"
            class="form-control"
            placeholder="例: 太郎"
            [(ngModel)]="employee.firstName"
            name="firstName"
            required
            #firstNameInput="ngModel"
          />
          <div
            *ngIf="firstNameInput.invalid && firstNameInput.touched"
            class="form-text text-danger"
          >
            名を入力してください。
          </div>
        </div>
      </div>

      <!-- パスワード -->
      <div class="row mb-4">
        <div class="col-12 col-md-6">
          <label for="password" class="form-label">
            パスワード
            <small class="text-muted d-block">
              9～16文字で、英大文字・英小文字・数字・記号を含めてください。
            </small>
            <small class="text-muted d-block">
              ※パスワードは変更する場合のみ入力してください。
            </small>
          </label>

          <div class="input-group">
            <input
                [type]="showPassword ? 'text' : 'password'"
                id="password"
                class="form-control"
                [(ngModel)]="employee.password"
                name="password"
                minlength="9"
                maxlength="16"
                #passwordInput="ngModel"
                inputmode="latin"
                autocomplete="new-password"
                style="ime-mode: disabled"
                (input)="sanitizePassword($event)"
                (ngModelChange)="checkPasswordStrength($event)"
              />

              <button
                type="button"
                class="btn btn-outline-secondary"
                (click)="togglePassword()"
                tabindex="-1"
              >
                <i
                  class="bi"
                  [ngClass]="showPassword ? 'bi-eye-slash' : 'bi-eye'"
                ></i>
              </button>
          </div>
          <div
            *ngIf="
              passwordInput.invalid &&
              (passwordInput.dirty || passwordInput.value)
            "
            class="form-text text-danger"
          >
            9～16文字で、英大文字・英小文字・数字・記号を含めてください。
          </div>

          <div *ngIf="passwordStrength" class="mt-2">
            <!-- 色付きバー（レスポンシブ対応） -->
            <div
              class="progress"
              style="height: 8px; max-width: 260px; width: 100%"
            >
              <div
                class="progress-bar"
                role="progressbar"
                [ngClass]="{
                  'bg-danger': passwordStrengthClass === 'text-danger',
                  'bg-warning': passwordStrengthClass === 'text-warning',
                  'bg-success': passwordStrengthClass === 'text-success'
                }"
                style="width: 100%"
              ></div>
            </div>

            <!-- アイコン＋テキスト -->
            <div class="d-flex mt-1">
              <i
                class="bi"
                [ngClass]="{
                  'bi-x-circle-fill text-danger':
                    passwordStrengthClass === 'text-danger',
                  'bi-exclamation-circle-fill text-warning':
                    passwordStrengthClass === 'text-warning',
                  'bi-check-circle-fill text-success':
                    passwordStrengthClass === 'text-success'
                }"
                style="margin-right: 6px"
              ></i>
              <small [ngClass]="passwordStrengthClass" class="fw-bold m-0">
                {{ passwordStrength }}
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- メールアドレス -->
      <div class="row mb-4">
        <div class="col-12 col-md-6">
          <label for="email" class="form-label">メールアドレス</label>
          <input
            type="email"
            id="email"
            class="form-control"
            placeholder="example@example.com"
            [(ngModel)]="employee.email"
            name="email"
            required
            email
            #emailInput="ngModel"
            (ngModelChange)="onEmailChange()"
          />
          <div
            *ngIf="emailInput.invalid && emailInput.touched"
            class="form-text text-danger"
          >
            有効なメールアドレスを入力してください。
          </div>
        </div>
      </div>

      <!-- 権限 & 所属 -->
      <div *ngIf="!selfMode || isAdmin" class="row g-3 mb-4">
        <!-- 権限 -->
        <div class="col-12 col-md-6">
          <label for="role" class="form-label">権限</label>
          <select
            id="role"
            class="form-select"
            [(ngModel)]="employee.role"
            name="role"
            required
            #roleInput="ngModel"
            (ngModelChange)="onRoleChange()"
          >
            <option *ngFor="let option of roleOptions" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
          <div
            *ngIf="roleInput.invalid && roleInput.touched"
            class="form-text text-danger"
          >
            権限を選択してください。
          </div>
        </div>

        <!-- 所属 -->
        <div *ngIf="!selfMode || isAdmin" class="col-12 col-md-6">
          <label for="departmentName" class="form-label">所属</label>
          <select
            id="departmentName"
            class="form-select"
            [(ngModel)]="employee.departmentName"
            name="departmentName"
            required
            #departmentInput="ngModel"
          >
            <option value="" disabled>-- 所属を選択 --</option>
            <option *ngFor="let dept of departments" [value]="dept.name">
              {{ dept.name }}
            </option>
          </select>
          <div
            *ngIf="departmentInput.invalid && departmentInput.touched"
            class="form-text text-danger"
          >
            所属を選択してください。
          </div>
        </div>
      </div>

      <div *ngIf="!selfMode || isAdmin" class="row mb-4">
        <div class="col-12 col-md-6">
          <label for="employmentStatus" class="form-label">
            雇用状態
          </label>
          <select
            id="employmentStatus"
            class="form-select"
            [(ngModel)]="employee.employmentStatus"
            name="employmentStatus"
          >
            <option
              *ngFor="let s of employmentStatusOptions"
              [value]="s.value"
            >
              {{ s.label }}
            </option>
          </select>
        </div>
      </div>

      <!-- 保存ボタン -->
      <div class="text-end mt-4">
        <app-button
            type="submit"
            label="保存"
            icon="save"
            color="blue"
            size="md"
            [disabled]="form.invalid || isPasswordInvalid()">
          </app-button>
      </div>
    </form>
  </div>
</div>
