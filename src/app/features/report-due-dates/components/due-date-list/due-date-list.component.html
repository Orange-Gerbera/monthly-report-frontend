<div class="container pt-5 pb-5">
  <div class="page-card">
    <h1 class="mb-4 border-bottom pb-2 mt-4 d-flex align-items-center">
      <app-icon name="calendar-days_bk" class="title-icon me-3"></app-icon>
      提出期日一覧
    </h1>

    <!-- 操作バー（年度選択・年度管理・提出期日編集） -->
    <div
      class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2 gap-md-3 mb-4"
    >
      <!-- 年度選択 -->
      <mat-form-field appearance="fill" style="width: 200px" class="me-md-2">
        <mat-label>年度を選択</mat-label>
        <mat-select [(ngModel)]="selectedYear" (selectionChange)="filterByYear()">
          <mat-option *ngFor="let y of years" [value]="y">{{ y }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- 年度管理ボタン -->
      <app-button
        [label]="isRegistering ? 'キャンセル' : '年度管理'"
        [icon]="isRegistering ? 'close' : 'settings'"
        (click)="!isEditing && toggleRegistering()"
        [disabled]="isEditing"
        color="blue"
        size="md"
        class="me-md-2"
        [block]="true"
      ></app-button>

      <!-- 編集ボタン -->
      <ng-container *ngIf="!isEditing">
        <app-button
          label="提出期日編集"
          icon="edit"
          color="green"
          size="md"
          (click)="!isRegistering && startEdit()"
          [disabled]="isRegistering"
          class="me-md-2"
          [block]="true"
        ></app-button>
      </ng-container>

      <!-- 保存・キャンセル（編集中） -->
      <ng-container *ngIf="isEditing">
        <app-button
          label="保存"
          icon="save"
          color="green"
          size="md"
          (click)="!hasEmptyDueDates && saveAllDueDates()"
          [disabled]="hasEmptyDueDates"
          class="me-md-2"
          [block]="true"
        ></app-button>

        <app-button
          label="キャンセル"
          icon="close"
          color="gray"
          size="md"
          (click)="cancelEdit()"
          class="me-md-2"
          [block]="true"
        ></app-button>
      </ng-container>
    </div>

    <!-- 年度登録フォーム（トグル表示） -->
    <div
      *ngIf="isRegistering"
      class="d-flex flex-column flex-md-row align-items-md-center gap-2 mb-3"
    >
      <mat-form-field appearance="outline" style="width: 150px">
        <mat-label>新しい年を登録</mat-label>
        <input
          matInput
          type="number"
          [(ngModel)]="newYear"
          placeholder="例: 2025"
        />
      </mat-form-field>
      <app-button
        label="登録"
        icon="add"
        (click)="registerYear()"
        color="blue"
        size="md"
        [block]="true"
      ></app-button>
      <app-button
        label="削除"
        icon="delete"
        (click)="deleteYear()"
        color="red"
        size="md"
        [block]="true"
      ></app-button>
    </div>

    <!-- 一覧テーブル -->
    <div class="table-scroll">
      <table mat-table [dataSource]="filteredDueDates.slice(0, 6)" class="w-100 app-table">

        <!-- 前半（1月〜6月） -->
        <ng-container matColumnDef="firstHalf">
          <th mat-header-cell *matHeaderCellDef>1月〜6月</th>
          <td mat-cell *matCellDef="let due; let i = index">
            <div class="due-row">
              <div class="due-month">{{ due.month }}月</div>

              <ng-container *ngIf="isEditing; else readOnly1">
                <input
                  class="due-input"
                  type="datetime-local"
                  [(ngModel)]="due.dueDateTime"
                  name="dueDateTime{{ i }}"
                  required
                />
              </ng-container>

              <ng-template #readOnly1>
                {{ due.dueDateTime | date : "M/dd(EEE) HH:mm"  }}
              </ng-template>
            </div>
          </td>
        </ng-container>

        <!-- 後半（7月〜12月） -->
        <ng-container matColumnDef="secondHalf">
          <th mat-header-cell *matHeaderCellDef>7月〜12月</th>
          <td mat-cell *matCellDef="let due; let i = index">
            <ng-container *ngIf="filteredDueDates[i + 6] as later">
              <div class="due-row">
                <div class="due-month">{{ later.month }}月</div>

                <ng-container *ngIf="isEditing; else readOnly2">
                  <input
                    class="due-input"
                    type="datetime-local"
                    [(ngModel)]="later.dueDateTime"
                    name="dueDateTimeLater{{ i }}"
                    required
                  />
                </ng-container>

                <ng-template #readOnly2>
                  {{ later.dueDateTime | date : "M/dd(EEE) HH:mm" }}
                </ng-template>
              </div>
            </ng-container>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['firstHalf','secondHalf']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['firstHalf','secondHalf']"></tr>

      </table>
    </div>
  </div>
</div>
