<div class="container pt-5 pb-5">
  <div class="page-card">
    <div class="d-flex mt-4 mb-4 pb-2 align-items-end">
      <div class="flex-grow-1 border-bottom me-3 pb-2">
        <h1 class="h1 mb-0 d-flex align-items-center">
          <app-icon name="document-duplicate_bk" class="me-2"></app-icon>
          報告書一覧
        </h1>
      </div>

      <div class="col-auto pb-2">
        <app-button
          label="選択した報告書を出力"
          icon="arrow-down-on-square-stack"
          color="green"
          size="md"
          (click)="exportSelectedReports()"
        />
      </div>
    </div>

    <div [hidden]="!loading" class="d-flex justify-content-center my-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div class="d-flex justify-content-end mb-3">
      <app-select
        label="表示月"
        [options]="reportMonthList"
        [(ngModel)]="selectedMonth"
        (ngModelChange)="updateTableData()"
        [optionLabelFn]="'formatDate'"
        valueFormat="month"
        class="month-select"
      />
    </div>

    <div class="table-responsive" [hidden]="loading">
      <table mat-table [dataSource]="dataSource" matSort class="app-table">
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox
              (change)="toggleAllSelection($event.checked)"
              [checked]="isAllSelected()"
              [indeterminate]="isSomeSelected()"
            ></mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let report">
            <mat-checkbox
              (change)="toggleSelection(report)"
              [checked]="isSelected(report)"
            ></mat-checkbox>
          </td>
        </ng-container>

        <ng-container matColumnDef="employeeName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>氏名</th>
          <td mat-cell *matCellDef="let report">{{ report.employeeName }}</td>
        </ng-container>

        <ng-container matColumnDef="reportMonth">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>日付</th>
          <td mat-cell *matCellDef="let report">
            {{ formatDate(report.reportMonth, "month") }}
          </td>
        </ng-container>

        <ng-container matColumnDef="dueDate">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>提出期日</th>
          <td mat-cell *matCellDef="let report">
            <ng-container *ngIf="report.dueDate">
              {{ formatDate(report.dueDate, "datetime") }}
            </ng-container>
          </td>
        </ng-container>

        <ng-container matColumnDef="submittedAt">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>提出日</th>
          <td mat-cell *matCellDef="let report">
            <ng-container *ngIf="report.completeFlg && report.submittedAt; else unsubmittedText">
              {{ report.submittedAt | date : "yyyy/MM/dd" }}
            </ng-container>
            <ng-template #unsubmittedText>
              <span>未提出</span>
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="departmentName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>所属</th>
          <td mat-cell *matCellDef="let report">
            {{ report.departmentName }}
          </td>
        </ng-container>

        <ng-container matColumnDef="completeFlg">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>完了</th>
          <td mat-cell *matCellDef="let report">
            <app-icon *ngIf="report.completeFlg" name="check_bk"></app-icon>
          </td>
        </ng-container>

        <ng-container matColumnDef="approvalFlg">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>承認</th>
          <td mat-cell *matCellDef="let report">
            <ng-container [ngSwitch]="report.approvalFlg">
              <app-icon *ngSwitchCase="true" name="check_bk"></app-icon>
              <span *ngSwitchCase="false" class="text-danger">否認</span>
            </ng-container>
          </td>
        </ng-container>

        <ng-container matColumnDef="comment">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>コメント</th>
          <td mat-cell *matCellDef="let report">
            <app-icon *ngIf="report.comment" name="check_bk"></app-icon>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="text-center"></th>
          <td mat-cell *matCellDef="let report" class="text-center">
            <app-button
              label="報告書"
              icon="document-text_bk"
              color="yellow"
              size="md"
              [routerLink]="['/reports', report.id]">
            </app-button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>

    <ng-template #noReports>
      <p>データが存在しません。</p>
    </ng-template>
  </div>
</div>